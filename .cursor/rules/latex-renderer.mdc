---
alwaysApply: true
---

# LaTeX Renderer System

## üîí CRITICAL SECURITY REQUIREMENTS

**DOMPurify sanitization MUST be active in LatexRenderer.jsx.** Processes untrusted LLM output ‚Äî XSS risk without it.

**Required implementation:**
- `import DOMPurify from 'dompurify';` in LatexRenderer.jsx
- `DOMPURIFY_CONFIG` constant defined (see below)
- `renderedHtml` useMemo calls `DOMPurify.sanitize()` AFTER `renderLatexToHtml()`
- `dangerouslySetInnerHTML` receives ONLY sanitized HTML

### DOMPurify Configuration (REQUIRED)

```javascript
const DOMPURIFY_CONFIG = {
  ALLOWED_TAGS: [
    'div', 'span', 'p', 'br', 'hr', 'strong', 'b', 'em', 'i', 'u', 's', 'sub', 'sup', 'small',
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'dl', 'dt', 'dd',
    'table', 'thead', 'tbody', 'tr', 'th', 'td',
    'math', 'semantics', 'mrow', 'mi', 'mo', 'mn', 'msup', 'msub', 'mfrac', 'mroot', 
    'msqrt', 'mtext', 'mspace', 'mtable', 'mtr', 'mtd', 'annotation', 'annotation-xml',
    'svg', 'path', 'line', 'rect', 'circle', 'g', 'use', 'defs', 'clippath',
  ],
  ALLOWED_ATTR: [
    'class', 'id', 'title', 'style',
    'mathvariant', 'encoding', 'xmlns', 'displaystyle', 'scriptlevel',
    'columnalign', 'rowalign', 'columnspacing', 'rowspacing', 'stretchy',
    'symmetric', 'fence', 'separator', 'lspace', 'rspace', 'accent',
    'accentunder', 'movablelimits', 'minsize', 'maxsize', 'width', 'height',
    'd', 'viewBox', 'preserveAspectRatio', 'fill', 'stroke', 'stroke-width',
    'transform', 'x', 'y', 'dx', 'dy', 'x1', 'y1', 'x2', 'y2', 'r', 'cx', 'cy',
    'href', 'xlink:href', 'clip-path',
  ],
  ALLOW_DATA_ATTR: false,
  ALLOW_ARIA_ATTR: false,
  FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form', 'input', 'button', 'textarea', 'select', 'option', 'link', 'style', 'base', 'meta'],
  FORBID_ATTR: ['onerror', 'onclick', 'onload', 'onmouseover', 'onfocus', 'onblur', 'onchange', 'onsubmit', 'onkeydown', 'onkeyup', 'onmousedown', 'onmouseup'],
  SANITIZE_DOM: true,
};
```

### Sanitization Point (REQUIRED)

```javascript
const renderedHtml = useMemo(() => {
  if (viewMode === 'raw' || !content) return null;
  const rawHtml = renderLatexToHtml(content);
  return DOMPurify.sanitize(rawHtml, DOMPURIFY_CONFIG);
}, [content, viewMode]);
```

---

## Overview

Dual rendering: **Rendered LaTeX View** (KaTeX math, dark theme on screen, white for PDFs) and **Raw Text View** (plain text, dark theme). All rendering flows through `LatexRenderer.jsx` (`frontend/src/components/LatexRenderer.jsx`). CSS in `LatexRenderer.css`. PDF generation via `downloadHelpers.js`.

### Props API

```javascript
<LatexRenderer
  content={string}       // Raw content to render
  className={string}     // Optional CSS class
  showToggle={boolean}   // Show Rendered/Raw toggle (default: false)
  defaultRaw={boolean}   // Start in raw mode (default: false)
  showLatex={boolean}    // External view mode control (optional)
/>
```

---

## Rendering Pipeline (CRITICAL ORDER)

Must execute in this exact order in `renderLatexToHtml()`:

1. **`decodeHtmlEntities()`** ‚Äî FIRST
2. **`autoWrapMath()`** ‚Äî Auto-wrap unwrapped math
3. **`processTheoremEnvironments()`** ‚Äî TikZ handling happens HERE (all three patterns: `\[...\]`, `$$...$$`, standalone)
4. **`replaceSectionCommand()`** ‚Äî Section headers
5. **Text formatting, citations, footnotes, lists, tables, QED symbols**
6. **KaTeX rendering** via `renderKatexSafely()` ‚Äî `maxExpand: 5000`, skips HTML placeholder content
7. **Line breaks/horizontal rules** (`\\` ‚Üí `<br/>`, `\hrule` ‚Üí `<hr/>`) ‚Äî AFTER KaTeX
8. **DOMPurify sanitization** ‚Äî LAST

**Critical:** `\\` line break conversion MUST be after KaTeX (valid syntax in `aligned`, `matrix`, etc.)

---

## Download System (`frontend/src/utils/downloadHelpers.js`)

**`downloadPDF()`**: Clone DOM ‚Üí apply light theme (white bg, black text, SVG to black) ‚Üí add metadata header ‚Üí html2pdf.js (A4, scale 2, `backgroundColor: '#ffffff'`) ‚Üí add page numbers.

**`downloadRawText()`**: Combine outline + content ‚Üí Blob (UTF-8) ‚Üí browser download.

**`sanitizeFilename()`**: Remove special chars, underscores for whitespace, truncate to 200 chars.

**Required dependency versions** (security fixes):
- `html2pdf.js` ^0.14.0 (XSS fix GHSA-w8x4-x68c-m6fc)
- `jspdf` ^4.1.0 (LFI/Path Traversal CVE-2025-68428 + PDF Injection CVE-2026-24737)
- `dompurify` ^3.2.4 (mXSS fix)

---

## Component Integration

| Component | Location | PDF | Toggle | Notes |
|-----------|----------|-----|--------|-------|
| LivePaper.jsx | compiler/ | ‚úÖ | ‚úÖ | Real-time paper viewing |
| PaperLibrary.jsx | autonomous/ | ‚úÖ | ‚úÖ | Paper library cards |
| FinalAnswerView.jsx | autonomous/ | ‚úÖ | ‚úÖ | Tier 3 final answer (defaults to raw for performance) |
| LiveResults.jsx | aggregator/ | ‚ùå | ‚úÖ | Aggregator submissions |
| BrainstormList.jsx | autonomous/ | ‚ùå | ‚ùå | Simple text display |

### PDF Download Usage

```javascript
const element = ref.current.querySelector('.latex-rendered-content');
const metadata = { title, wordCount, date, models };
await downloadPDF(element, metadata, sanitizeFilename(`${id}_${title}`));
```

---

## Paper Critique Modal (`PaperCritiqueModal.jsx`)

Ratings: Novelty, Correctness, Impact (1-10 scale). Up to 10 history entries. Regeneration with custom prompt.

**Integration localStorage keys:**
- `autonomous_critique_custom_prompt` ‚Äî PaperLibrary + FinalAnswerView
- `compiler_critique_custom_prompt` ‚Äî LivePaper

---

## System Invariants

1. ALL model output MUST be sanitized ‚Äî no exceptions
2. DOMPurify MUST block scripts ‚Äî never relax FORBID_TAGS
3. Sanitization MUST occur AFTER LaTeX conversion
4. HTML entities MUST be decoded before LaTeX processing (first step)
5. TikZ environments MUST be pre-processed ‚Äî KaTeX cannot render them; remove surrounding math delimiters (all three patterns)
6. KaTeX maxExpand MUST be 5000
7. Line break conversion MUST happen AFTER KaTeX ‚Äî prevents SVG corruption
8. Rendering pipeline order MUST be preserved
9. Raw text view never processes HTML ‚Äî plain text only
10. PDF generation captures sanitized content
